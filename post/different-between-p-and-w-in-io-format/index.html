<!DOCTYPE html>
<html lang="zh-cn"
  x-data
  :class="$store.darkMode.class()"
  :data-theme="$store.darkMode.theme()">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>io_lib:format 中文乱码探究 | 白日梦想马</title>

    



<meta name="author" content="map[name:bobo]" />
<meta name="description" content="一蓑烟雨的随记" />


<link rel="canonical" href="https://blog.luckyanna.cn/post/different-between-p-and-w-in-io-format/" />


<meta property="og:url" content="https://blog.luckyanna.cn/post/different-between-p-and-w-in-io-format/">
  <meta property="og:site_name" content="白日梦想马">
  <meta property="og:title" content="io_lib:format 中文乱码探究">
  <meta property="og:description" content="最近发现erlang项目的配置文件某些中文显示会乱码，先说下配置文件的实现： 由file:consult/1读取配置的原始文件（一系列的erl">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2015-12-09T11:11:26+00:00">
    <meta property="article:modified_time" content="2015-12-09T11:11:26+00:00">
    <meta property="article:tag" content="Erlang">




  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="io_lib:format 中文乱码探究">
  <meta name="twitter:description" content="最近发现erlang项目的配置文件某些中文显示会乱码，先说下配置文件的实现： 由file:consult/1读取配置的原始文件（一系列的erl">



<meta name="generator" content="Hugo 0.130.0">

<link rel="stylesheet" href="/css/output.css" />

<style>



</style>


    


<style>
  pre {
    padding: 1em;
    overflow: auto;
  }
</style>



<script src='//unpkg.com/valine/dist/Valine.min.js'></script>




    

    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  </head>

  <body x-data="{
    flip: false,
  }">
    
    <div id="dream-global-bg"></div>

    
<nav class="mt-4 lg:mt-8 py-4">

  <div class="container flex justify-between px-4">
    <section class="flex items-center gap-4">
      <div class="avatar cursor-pointer hover:online" @click="flip = !flip" title="">
        <div class="h-10 rounded-full">
          <img src="/" alt="" />
        </div>
      </div>

      
    </section>

    <div class="dropdown dropdown-end sm:hidden">
      <div tabindex="0" role="button" class="btn btn-ghost btn-square">
        <ion-icon name="menu-outline" size="large"></ion-icon>
      </div>
      <ul tabindex="0" class="dropdown-content menu w-36 bg-base-100 rounded-box z-[1] shadow-md">
        






<li>
  <a class="inline-flex items-center p-2 cursor-pointer" href="/categories" title="">
    <ion-icon name="grid"></ion-icon>
    
  </a>
</li>



<li>
  <a class="inline-flex items-center p-2 cursor-pointer" href="/tags" title="">
    <ion-icon name="pricetags"></ion-icon>
    
  </a>
</li>




      </ul>
    </div>
    <section class="hidden sm:flex sm:items-center sm:gap-2 md:gap-4">
      

      

      

      
      <a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="/categories" title="">
        <ion-icon class="group-hover:text-primary-content" name="grid"></ion-icon>
      </a>
      

      
      <a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="/tags" title="">
        <ion-icon class="group-hover:text-primary-content" name="pricetags"></ion-icon>
      </a>
      

      
    </section>
  </div>
</nav>


    <div class="flip-container" :class="{ 'flip-it': flip }">
      <div class="flipper">
        <div class="front">
          <div class="container">
            
<div class="mt-4 px-4">
  
  <div>
  
    
    <article class="mx-auto prose dark:prose-invert" id="dream-single-post-main">
      <header>
        <h1>io_lib:format 中文乱码探究</h1>
        <p class="text-sm">
          
            
              Wednesday, Dec 9, 2015
            
          

          | <span>2</span>

          
          | <span>
            
              
                Wednesday, Dec 9, 2015
              
            </span>
          
        </p>
        <div class="flex justify-between">
          <div class="flex items-center">
  
  <span>@</span>
  

  <span>
  
    map[name:bobo]
  
  </span>
</div>


          <span class="flex items-center gap-2">
  <a class="group inline-flex items-center p-2 text-sm rounded-full cursor-pointer hover:bg-primary" href="https://twitter.com/intent/tweet?text=io_lib%3aformat%20%e4%b8%ad%e6%96%87%e4%b9%b1%e7%a0%81%e6%8e%a2%e7%a9%b6&url=https%3a%2f%2fblog.luckyanna.cn%2fpost%2fdifferent-between-p-and-w-in-io-format%2f" title="Share on X">
    <ion-icon class="group-hover:text-primary-content" name="logo-x"></ion-icon>
  </a>
  <a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.luckyanna.cn%2fpost%2fdifferent-between-p-and-w-in-io-format%2f" title="Share on Facebook">
    <ion-icon class="group-hover:text-primary-content" name="logo-facebook"></ion-icon>
  </a>
</span>

        </div>
      </header>

      

      <p>最近发现erlang项目的配置文件某些中文显示会乱码，先说下配置文件的实现：</p>
<ol>
<li>由file:consult/1读取配置的原始文件（一系列的erlang term），获取到原始的 erlang term</li>
<li>再转化成erlang 代码 然后再会写到文件。</li>
</ol>
<p>问题就出在了转化erlang 代码这里，我们使用的是<code>io_lib:format(&quot;~p&quot;,[data])</code> 来将erlang term 转化成字符串再回写到文件，而 <code>io:format/2</code>关于<code>~p/~w</code>在官方文档里面有这样的描述：</p>
<blockquote>
<p>w
Writes data with the standard syntax. This is used to output Erlang terms. Atoms are printed within quotes if they contain embedded non-printable
characters, and floats are printed accurately as the shortest, correctly rounded string.
p
Writes the data with standard syntax in the same way as ~w, but breaks terms whose printed representation is longer than one line into many lines and
indents each line sensibly. It also tries to detect lists of printable characters and to output these as strings. The Unicode translation modifier is used for
determining what characters are printable.</p>
</blockquote>
<p>也就是说，当我们使用<code>io:format(&quot;~p&quot;,[Data])</code>来显示数据时，会根据data的binary数据是否可以转化成unicode可打印字符来打印数据，这时候中文的unicode就会每个字节逐个转化unicode
因此：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-erlang" data-lang="erlang"><span class="line"><span class="cl"><span class="mi">6</span><span class="o">&gt;</span> <span class="nv">Bin1</span><span class="o">=</span><span class="nn">unicode</span><span class="p">:</span><span class="nf">characters_to_binary</span><span class="p">(</span><span class="s">&#34;书鬼&#34;</span><span class="p">).</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;&lt;</span><span class="mi">228</span><span class="p">,</span><span class="mi">185</span><span class="p">,</span><span class="mi">166</span><span class="p">,</span><span class="mi">233</span><span class="p">,</span><span class="mi">172</span><span class="p">,</span><span class="mi">188</span><span class="o">&gt;&gt;</span>
</span></span><span class="line"><span class="cl"><span class="mi">7</span><span class="o">&gt;</span> <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;</span><span class="si">~p</span><span class="s">&#34;</span><span class="p">,[</span><span class="nv">Bin1</span><span class="p">]).</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;&lt;</span><span class="s">&#34;ä¹¦é¬¼&#34;</span><span class="o">&gt;&gt;</span><span class="n">ok</span>
</span></span><span class="line"><span class="cl"><span class="mi">8</span><span class="o">&gt;</span> <span class="nv">Bin2</span><span class="o">=</span><span class="nn">unicode</span><span class="p">:</span><span class="nf">characters_to_binary</span><span class="p">(</span><span class="s">&#34;书盲&#34;</span><span class="p">).</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;&lt;</span><span class="mi">228</span><span class="p">,</span><span class="mi">185</span><span class="p">,</span><span class="mi">166</span><span class="p">,</span><span class="mi">231</span><span class="p">,</span><span class="mi">155</span><span class="p">,</span><span class="mi">178</span><span class="o">&gt;&gt;</span>
</span></span><span class="line"><span class="cl"><span class="mi">9</span><span class="o">&gt;</span> <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;</span><span class="si">~p</span><span class="s">&#34;</span><span class="p">,[</span><span class="nv">Bin2</span><span class="p">]).</span>    
</span></span><span class="line"><span class="cl"><span class="o">&lt;&lt;</span><span class="mi">228</span><span class="p">,</span><span class="mi">185</span><span class="p">,</span><span class="mi">166</span><span class="p">,</span><span class="mi">231</span><span class="p">,</span><span class="mi">155</span><span class="p">,</span><span class="mi">178</span><span class="o">&gt;&gt;</span><span class="n">ok</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="mi">48</span><span class="o">&gt;</span> <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;</span><span class="si">~w</span><span class="s">&#34;</span><span class="p">,[</span><span class="nv">Bin1</span><span class="p">]).</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;&lt;</span><span class="mi">228</span><span class="p">,</span><span class="mi">185</span><span class="p">,</span><span class="mi">166</span><span class="p">,</span><span class="mi">233</span><span class="p">,</span><span class="mi">172</span><span class="p">,</span><span class="mi">188</span><span class="o">&gt;&gt;</span><span class="n">ok</span>
</span></span><span class="line"><span class="cl"><span class="mi">49</span><span class="o">&gt;</span> <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;</span><span class="si">~w</span><span class="s">&#34;</span><span class="p">,[</span><span class="nv">Bin2</span><span class="p">]).</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;&lt;</span><span class="mi">228</span><span class="p">,</span><span class="mi">185</span><span class="p">,</span><span class="mi">166</span><span class="p">,</span><span class="mi">231</span><span class="p">,</span><span class="mi">155</span><span class="p">,</span><span class="mi">178</span><span class="o">&gt;&gt;</span><span class="n">ok</span>
</span></span></code></pre></td></tr></table>
</div>
</div>

      
    </article>
  </div>

  

  
  <div class="divider max-w-[65ch] mx-auto"></div>
  

  <section class="max-w-[65ch] mx-auto space-y-4">
    

    

    
    <article>
      <div id="vcomments"></div>
    </article>
    <script>
      new Valine({
        el: '#vcomments',
        appId: '',
        appKey: '',
        lang: ''
      })
    </script>
    
  </section>
</div>


            <footer class="flex justify-between items-center gap-2 px-4 py-12">
              <div>
  
  <p>© 2024 白日梦想马</p>
  

  
  <p class="text-sm">
    🌱
    <span class="text-base-content/60">
      Powered by <a class="hover:underline" href="https://gohugo.io/" target="_blank">Hugo</a> with theme
      <a class="hover:underline" href="https://github.com/g1eny0ung/hugo-theme-dream" target="_blank">Dream</a>.</span
    >
  </p>
  
</div>

              <div
  x-data="{ icons: [
    { name: 'moon', status: 'y' },
    { name: 'sunny', status: 'n' },
    { name: 'desktop', status: 'auto' }
  ] }"
  class="flex items-center h-[32px] px-2 gap-2 border border-base-300 rounded-full"
>
  <template x-for="icon in icons">
    <div
      role="button"
      tabindex="0"
      class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary"
      :class="$store.darkMode.icon() === icon.name && 'bg-primary'"
      @click="$store.darkMode.toggle(icon.status)"
    >
      <ion-icon
        :name="`${icon.name}-outline`"
        class="group-hover:text-primary-content"
        :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"
      >
      </ion-icon>
    </div>
  </template>
</div>

            </footer>
          </div>
        </div>
        <div class="back">
          <div class="container">
            <div class="dream-grid">
  

  

  
  
</div>

          </div>
        </div>
      </div>
    </div>

    <script>
  window.lightTheme =  null 
  window.darkTheme =  null 

  window.hasTwitterEmbed =  null 
  if (window.hasTwitterEmbed) {
    
    window.twttr = (function (d, s, id) {
      var js,
        fjs = d.getElementsByTagName(s)[0],
        t = window.twttr || {}
      if (d.getElementById(id)) return t
      js = d.createElement(s)
      js.id = id
      js.src = 'https://platform.twitter.com/widgets.js'
      fjs.parentNode.insertBefore(js, fjs)

      t._e = []
      t.ready = function (f) {
        t._e.push(f)
      }

      return t
    })(document, 'script', 'twitter-wjs')
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script>
<script src="/js/grid.js"></script>
<script src="/js/main.js"></script>

    







    

    
    
  
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-FSJCZK2XT2"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-FSJCZK2XT2');
        }
      </script>
    
  


    

    <script type="module" src="https://unpkg.com/ionicons@7.4.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.4.0/dist/ionicons/ionicons.js"></script>
  </body>
</html>
